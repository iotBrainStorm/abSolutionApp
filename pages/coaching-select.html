<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Choose Coaching - Student Portal</title>
    <link rel="stylesheet" href="../css/style.css" />
    <link rel="stylesheet" href="../css/responsive.css" />
    <style>
      .coaching-selection-container {
        min-height: 90vh;
        display: flex;
        /* align-items: center; */
        margin-top: 20px;
        margin-bottom: 20px;
        justify-content: center;
        padding: 10px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      .coaching-box {
        background: white;
        border-radius: 20px;
        padding: 25px;
        max-width: 800px;
        width: 100%;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      }

      .coaching-header {
        text-align: center;
        margin-bottom: 20px;
      }

      .coaching-header h1 {
        color: #333;
        font-size: 2rem;
        margin-bottom: 3px;
      }

      .coaching-header .subtitle {
        color: #666;
        font-size: 1rem;
      }

      .welcome-message {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 10px;
        border-radius: 12px;
        color: white;
        /* margin-bottom: 30px; */
        text-align: center;
      }

      .welcome-message h2 {
        margin: 0 0 5px 0;
        font-size: 1.5rem;
      }

      .welcome-message p {
        margin: 0;
        opacity: 0.9;
      }

      .coaching-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
      }

      .coaching-card {
        background: linear-gradient(90deg, #667eea, #833ee4, #833ee4, #6a11cb);
        background-size: 300% 300%;
        animation: gradientAnimation 10s ease infinite;

        border-radius: 15px;
        padding: 10px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        color: white;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      /* Gradient Animation */
      @keyframes gradientAnimation {
        0% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
        100% {
          background-position: 0% 50%;
        }
      }

      .coaching-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        border-color: #fff;
      }

      .coaching-card.selected {
        border-color: #ffd700;
        box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
      }

      .coaching-card img {
        margin-bottom: 15px;
        background: white;
        padding: 10px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        filter: drop-shadow(0 0 12px rgba(0, 0, 0, 0.3));
      }

      .coaching-icon {
        font-size: 3rem;
        margin-bottom: 15px;
      }

      .coaching-name {
        font-size: 1.5rem;
        font-weight: 400;
        margin-bottom: 15px;
        color: #f2ff00;

        animation: zoomPulse 2s ease-in-out infinite;
        display: inline-block; /* important for scaling */
      }

      @keyframes zoomPulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.08);
        } /* small zoom */
        100% {
          transform: scale(1);
        }
      }

      .coaching-details {
        font-size: 0.9rem;
        opacity: 0.95;
        line-height: 1.6;
        text-align: left;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid rgba(255, 255, 255, 0.3);
      }

      .coaching-detail-item {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
      }

      .coaching-detail-item strong {
        min-width: 80px;
        font-weight: 600;
      }

      .continue-btn {
        width: 100%;
        padding: 15px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 20px;
      }

      .continue-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
      }

      .continue-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .logout-btn {
        width: 100%;
        padding: 12px;
        background: white;
        color: #667eea;
        border: 2px solid #667eea;
        border-radius: 10px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 10px;
        margin-bottom: 10px;
      }

      .logout-btn:hover {
        background: #667eea;
        color: white;
      }

      .loading-spinner {
        display: none;
        text-align: center;
        padding: 40px;
      }

      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .error-message {
        background: #ff4444;
        color: white;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="coaching-selection-container">
      <div class="coaching-box">
        <div class="coaching-header">
          <h1>üìö Choose Your Coaching</h1>
          <p class="subtitle">Select a coaching center to continue</p>
        </div>

        <div class="welcome-message" id="welcomeMessage">
          <h2>Welcome, <span id="userName">Student</span>! üëã</h2>
          <p>Please select your coaching center to access study materials</p>
        </div>
        <button class="logout-btn" onclick="window.handleLogout()">
          ‚Üê Logout
        </button>

        <div class="error-message" id="errorMessage"></div>

        <div class="loading-spinner" id="loadingSpinner">
          <div class="spinner"></div>
          <p>Loading coaching centers...</p>
        </div>

        <div class="coaching-grid" id="coachingGrid">
          <!-- Coaching cards will be dynamically loaded here -->
        </div>
      </div>
    </div>

    <script type="module" src="../js/main.js"></script>
    <script type="module">
      import { auth, database } from "../js/firebase-config.js";
      import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import {
        ref,
        get,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

      let selectedCoaching = null;

      // Check authentication
      onAuthStateChanged(auth, (user) => {
        if (!user) {
          window.location.href = "/src/index.html";
          return;
        }

        // Display user name
        document.getElementById("userName").textContent =
          user.displayName || user.email.split("@")[0];

        // Load coaching centers
        loadCoachingCenters();
      });

      // Load coaching centers from Firebase Realtime Database
      async function loadCoachingCenters() {
        const loadingSpinner = document.getElementById("loadingSpinner");
        const errorMessage = document.getElementById("errorMessage");
        const coachingGrid = document.getElementById("coachingGrid");

        try {
          loadingSpinner.style.display = "block";
          coachingGrid.innerHTML = "";

          const coachingRef = ref(database, "coaching-centers");
          const snapshot = await get(coachingRef);

          if (snapshot.exists()) {
            const coachings = snapshot.val();
            displayCoachingCenters(coachings);
          } else {
            // Default coaching centers if none in database
            const defaultCoachings = {
              "coaching-1": {
                id: "coaching-1",
                name: "Excellence Coaching",
                description: "Premier coaching for Classes 9-10",
                icon: "üéì",
              },
              "coaching-2": {
                id: "coaching-2",
                name: "NEET Academy",
                description: "Specialized NEET preparation",
                icon: "üè•",
              },
              "coaching-3": {
                id: "coaching-3",
                name: "JEE Institute",
                description: "Top JEE coaching center",
                icon: "‚ö°",
              },
            };
            displayCoachingCenters(defaultCoachings);
          }
        } catch (error) {
          console.error("Error loading coaching centers:", error);
          errorMessage.textContent =
            "Failed to load coaching centers. Please try again.";
          errorMessage.style.display = "block";
        } finally {
          loadingSpinner.style.display = "none";
        }
      }

      function displayCoachingCenters(coachings) {
        const coachingGrid = document.getElementById("coachingGrid");
        coachingGrid.innerHTML = "";

        Object.entries(coachings).forEach(([key, coaching]) => {
          const card = document.createElement("div");
          card.className = "coaching-card";
          card.onclick = () => selectCoaching(coaching.id, card);

          // Check if icon is an image path or emoji
          const iconHtml =
            coaching.icon &&
            (coaching.icon.includes(".png") ||
              coaching.icon.includes(".jpg") ||
              coaching.icon.includes(".jpeg"))
              ? `<img src="${coaching.icon}" alt="${coaching.name}" style="width: 80px; height: 80px; object-fit: contain; border-radius: 12px;">`
              : `<div class="coaching-icon">${coaching.icon}</div>`;

          card.innerHTML = `
                    ${iconHtml}
                    <div class="coaching-name">${coaching.name}</div>
                    <div class="coaching-details">
                        <div class="coaching-detail-item">
                            <strong>üë§ Owner:</strong> ${
                              coaching.owner || "N/A"
                            }
                        </div>
                        <div class="coaching-detail-item">
                            <strong>üìç Place:</strong> ${
                              coaching.place || "N/A"
                            }
                        </div>
                        <div class="coaching-detail-item">
                            <strong>üìû Mob:</strong> ${
                              coaching.contact || "N/A"
                            }
                        </div>
                    </div>
                `;

          coachingGrid.appendChild(card);
        });
      }

      async function selectCoaching(coachingId, cardElement) {
        try {
          // Get coaching name from Firebase
          const coachingRef = ref(database, "coaching-centers");
          const snapshot = await get(coachingRef);
          let coachingName = "Coaching Center";

          if (snapshot.exists()) {
            const coachings = snapshot.val();
            const coaching = Object.values(coachings).find(
              (c) => c.id === coachingId
            );
            if (coaching) {
              coachingName = coaching.name;
            }
          }

          // Store selection
          sessionStorage.setItem("selectedCoaching", coachingId);
          sessionStorage.setItem("selectedCoachingName", coachingName);

          // Navigate directly to classes page
          window.location.href = "main.html";
        } catch (error) {
          console.error("Error fetching coaching name:", error);
          // Store ID only if error occurs
          sessionStorage.setItem("selectedCoaching", coachingId);
          window.location.href = "main.html";
        }
      }

      window.handleLogout = async function () {
        try {
          await auth.signOut();
          sessionStorage.clear();
          window.location.href = "/index.html"; //for cloud hosting
          // window.location.href = "/src/index.html"; //for local testing
        } catch (error) {
          console.error("Logout error:", error);
        }
      };
    </script>
  </body>
</html>
